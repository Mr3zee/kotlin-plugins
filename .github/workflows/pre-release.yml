# Pre-release checks on release/latest: build, test, and verify for ALL IDE versions,
# run Qodana inspections, and create a release draft.

name: Pre-release
on:
  push:
    branches: [ 'release/latest' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  setup-ide-versions:
    name: Setup IDE versions
    runs-on: ubuntu-latest
    outputs:
      ide_versions: ${{ steps.versions.outputs.matrix }}
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v6

      - name: Get IDE Versions
        id: versions
        run: |
          VERSIONS=$(grep -oP '^ide\.\K[0-9]+(?=\.platformVersion)' gradle.properties | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "IDE versions: $VERSIONS"
          echo "matrix=$VERSIONS" >> $GITHUB_OUTPUT

  buildAll:
    name: Build & Test (IDE ${{ matrix.ide_version }})
    needs: [ setup-ide-versions ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ide_version: ${{ fromJson(needs.setup-ide-versions.outputs.ide_versions) }}
      fail-fast: false
    steps:
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Fetch Sources
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build plugin
        run: ./gradlew buildPlugin -PpluginIdeVersionMajor=${{ matrix.ide_version }}

      - name: Run Tests
        run: ./gradlew check -PpluginIdeVersionMajor=${{ matrix.ide_version }}

      - name: Run Plugin Verification
        run: ./gradlew verifyPlugin -PpluginIdeVersionMajor=${{ matrix.ide_version }}

      - name: Collect Tests Result
        if: ${{ failure() }}
        uses: actions/upload-artifact@v7
        with:
          name: tests-result-${{ matrix.ide_version }}
          path: ${{ github.workspace }}/build/reports/tests

      - name: Collect Plugin Verifier Result
        if: ${{ always() }}
        uses: actions/upload-artifact@v7
        with:
          name: pluginVerifier-result-${{ matrix.ide_version }}
          path: ${{ github.workspace }}/build/reports/pluginVerifier

  inspectCode:
    name: Inspect code
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write
      pull-requests: write
    steps:
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Fetch Sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 21

      - name: Qodana - Code Inspection
        uses: JetBrains/qodana-action@v2025.3.1
        with:
          cache-default-branch-only: true

  releaseDraft:
    name: Release draft
    needs: [ buildAll, inspectCode ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Remove Old Release Drafts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/{owner}/{repo}/releases \
            --jq '.[] | select(.draft == true) | .id' \
            | xargs -I '{}' gh api -X DELETE repos/{owner}/{repo}/releases/{}

      - name: Create Release Draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(sed -n 's/^pluginVersion *= *//p' gradle.properties | xargs)
          RELEASE_NOTE="./build/tmp/release_note.txt"
          ./gradlew getChangelog --unreleased --no-header --quiet --console=plain --output-file=$RELEASE_NOTE

          gh release create "$VERSION" \
            --draft \
            --title "$VERSION" \
            --notes-file "$RELEASE_NOTE"
