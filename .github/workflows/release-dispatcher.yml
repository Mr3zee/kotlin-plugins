# GitHub Actions Workflow that dispatches release jobs for all IDE versions
# Triggered when a release is published, or manually via workflow_dispatch.
# Reads the IDE version map from gradle.properties and triggers the release workflow
# for each version + the open-ended (latest) release.

name: Release Dispatcher
on:
  release:
    types: [prereleased, released]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (leave empty to use the latest release)'
        required: false
        type: string
        default: ''

jobs:
  dispatch:
    name: Dispatch Release Jobs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      ide_versions: ${{ steps.versions.outputs.matrix }}
      release_tag: ${{ steps.resolve-tag.outputs.tag }}
    steps:
      # Check out the current repository
      - name: Fetch Sources
        uses: actions/checkout@v6
        with:
          ref: release/latest

      # Resolve the release tag — use input, event, or latest release
      - name: Resolve Release Tag
        id: resolve-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          elif [[ -n "${{ inputs.tag }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG=$(gh release view --json tagName -q '.tagName')
          fi
          echo "Resolved release tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # Set up the Java environment for changelog updates
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 21

      # Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      # Fetch the release body for changelog patching
      - name: Fetch Release Body
        id: release-body
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.resolve-tag.outputs.tag }}"
          if [[ "${{ github.event_name }}" == "release" ]]; then
            BODY="${{ github.event.release.body }}"
          else
            BODY=$(gh release view "$TAG" --json body -q '.body')
          fi
          if [[ -n "$BODY" ]]; then
            echo "has_body=true" >> $GITHUB_OUTPUT
            RELEASE_NOTE="./build/tmp/release_note.txt"
            mkdir -p "$(dirname "$RELEASE_NOTE")"
            echo "$BODY" > "$RELEASE_NOTE"
          else
            echo "has_body=false" >> $GITHUB_OUTPUT
          fi

      # Update the Unreleased section with the current release note (once for all releases)
      - name: Patch Changelog
        if: steps.release-body.outputs.has_body == 'true'
        run: ./gradlew patchChangelog --release-note-file=./build/tmp/release_note.txt

      # Create a pull request with changelog updates
      - name: Create Pull Request
        if: steps.release-body.outputs.has_body == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.resolve-tag.outputs.tag }}"
          BRANCH="changelog-update-$VERSION"
          LABEL="release changelog"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Changelog update - $VERSION"
          git push --set-upstream origin $BRANCH

          gh label create "$LABEL" \
            --description "Pull requests with release changelog update" \
            --force \
            || true

          gh pr create \
            --title "Changelog update - \`$VERSION\`" \
            --body "Current pull request contains patched \`CHANGELOG.md\` file for the \`$VERSION\` version." \
            --label "$LABEL" \
            --head $BRANCH

      # Extract IDE major versions from the ide.*.platformVersion entries in gradle.properties
      - name: Get IDE Versions
        id: versions
        run: |
          VERSIONS=$(grep -oP '^ide\.\K[0-9]+(?=\.platformVersion)' gradle.properties | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "IDE versions: $VERSIONS"
          echo "matrix=$VERSIONS" >> $GITHUB_OUTPUT

  # Release for the open-ended (latest) version — no IDE version major set
  release-latest:
    name: Release (latest)
    needs: dispatch
    permissions:
      contents: write
    uses: ./.github/workflows/release.yml
    with:
      tag: ${{ needs.dispatch.outputs.release_tag }}
    secrets: inherit

  # Release for each IDE-specific version
  release-ide:
    name: Release (IDE ${{ matrix.ide_version }})
    needs: dispatch
    if: needs.dispatch.outputs.ide_versions != '[]'
    permissions:
      contents: write
    strategy:
      matrix:
        ide_version: ${{ fromJson(needs.dispatch.outputs.ide_versions) }}
      fail-fast: false
    uses: ./.github/workflows/release.yml
    with:
      ide_version_major: ${{ matrix.ide_version }}
      tag: ${{ needs.dispatch.outputs.release_tag }}
    secrets: inherit
