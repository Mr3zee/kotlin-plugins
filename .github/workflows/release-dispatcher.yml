# GitHub Actions Workflow that dispatches release jobs for all IDE versions
# Triggered when a release is published, this workflow reads the IDE version map
# from gradle.properties and triggers the release workflow for each version + the open-ended (latest) release

name: Release Dispatcher
on:
  release:
    types: [prereleased, released]

jobs:
  dispatch:
    name: Dispatch Release Jobs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      ide_versions: ${{ steps.versions.outputs.matrix }}
    steps:
      # Check out the current repository
      - name: Fetch Sources
        uses: actions/checkout@v5
        with:
          ref: release/latest

      # Set up the Java environment for changelog updates
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 21

      # Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      # Update the Unreleased section with the current release note (once for all releases)
      - name: Patch Changelog
        if: github.event.release.body != ''
        env:
          CHANGELOG: ${{ github.event.release.body }}
        run: |
          RELEASE_NOTE="./build/tmp/release_note.txt"
          mkdir -p "$(dirname "$RELEASE_NOTE")"
          echo "$CHANGELOG" > $RELEASE_NOTE

          ./gradlew patchChangelog --release-note-file=$RELEASE_NOTE

      # Create a pull request with changelog updates
      - name: Create Pull Request
        if: github.event.release.body != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          BRANCH="changelog-update-$VERSION"
          LABEL="release changelog"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Changelog update - $VERSION"
          git push --set-upstream origin $BRANCH

          gh label create "$LABEL" \
            --description "Pull requests with release changelog update" \
            --force \
            || true

          gh pr create \
            --title "Changelog update - \`$VERSION\`" \
            --body "Current pull request contains patched \`CHANGELOG.md\` file for the \`$VERSION\` version." \
            --label "$LABEL" \
            --head $BRANCH

      # Extract IDE major versions from the ide.*.platformVersion entries in gradle.properties
      - name: Get IDE Versions
        id: versions
        run: |
          VERSIONS=$(grep -oP '^ide\.\K[0-9]+(?=\.platformVersion)' gradle.properties | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "IDE versions: $VERSIONS"
          echo "matrix=$VERSIONS" >> $GITHUB_OUTPUT

  # Release for the open-ended (latest) version â€” no IDE version major set
  release-latest:
    name: Release (latest)
    needs: dispatch
    uses: ./.github/workflows/release.yml
    with:
      tag: ${{ github.event.release.tag_name }}
    secrets: inherit

  # Release for each IDE-specific version
  release-ide:
    name: Release (IDE ${{ matrix.ide_version }})
    needs: dispatch
    if: needs.dispatch.outputs.ide_versions != '[]'
    strategy:
      matrix:
        ide_version: ${{ fromJson(needs.dispatch.outputs.ide_versions) }}
      fail-fast: false
    uses: ./.github/workflows/release.yml
    with:
      ide_version_major: ${{ matrix.ide_version }}
      tag: ${{ github.event.release.tag_name }}
    secrets: inherit
